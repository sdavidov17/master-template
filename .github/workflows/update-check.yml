# Daily Update Check Workflow
# Checks upstream template repositories for updates

name: Check Template Updates

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  check-updates:
    name: Check Upstream Updates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run update check
        id: check
        run: |
          node scripts/update-check.js > update-report.txt 2>&1 || true
          if grep -q "Updates available" update-report.txt; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          cat update-report.txt

      - name: Create issue if updates available
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('update-report.txt', 'utf8');

            // Check for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'template-update'
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## Update Check - ${new Date().toISOString().split('T')[0]}\n\n\`\`\`\n${report}\n\`\`\``
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Template Updates Available',
                body: `## Template Updates Detected\n\nThe daily update check found new versions of upstream templates.\n\n\`\`\`\n${report}\n\`\`\`\n\n### Action Required\n\n1. Review the changes in upstream repos\n2. Decide which updates to incorporate\n3. Update this template as needed\n4. Close this issue when done`,
                labels: ['template-update', 'maintenance']
              });
            }
