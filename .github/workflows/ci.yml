# Trunk-Based CI Workflow
# Runs on every push to main and all PRs
# Includes quality gates, coverage enforcement, and security checks

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Coverage thresholds by architecture mode (configured in CLAUDE.md)
  # MVP: 60%, Growth: 80%, Scale: 90%
  COVERAGE_THRESHOLD: 80

jobs:
  detect-language:
    name: Detect Language
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect project language
        id: detect
        run: |
          if [ -f "package.json" ]; then
            echo "language=node" >> $GITHUB_OUTPUT
          elif [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
            echo "language=python" >> $GITHUB_OUTPUT
          elif [ -f "go.mod" ]; then
            echo "language=go" >> $GITHUB_OUTPUT
          else
            echo "language=generic" >> $GITHUB_OUTPUT
          fi

  node:
    name: Node.js CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.language == 'node'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Type check
        run: npm run typecheck --if-present || npx tsc --noEmit || true

      - name: Run tests with coverage
        run: |
          if npm run test:coverage --if-present 2>/dev/null; then
            echo "Coverage tests completed"
          elif npm test -- --coverage --if-present 2>/dev/null; then
            echo "Coverage tests completed"
          else
            npm test --if-present
          fi

      - name: Check coverage threshold
        if: hashFiles('coverage/coverage-summary.json') != ''
        run: |
          COVERAGE=$(node -e "const c = require('./coverage/coverage-summary.json'); console.log(c.total.lines.pct)")
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold of $COVERAGE_THRESHOLD%"
            exit 1
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always() && hashFiles('coverage/**') != ''
        with:
          name: coverage-report-node
          path: coverage/
          retention-days: 7

      - name: Build
        run: npm run build --if-present

  python:
    name: Python CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.language == 'python'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "pyproject.toml" ]; then
            pip install -e ".[dev]"
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov ruff black mypy

      - name: Run linter
        run: ruff check .

      - name: Check formatting
        run: black . --check

      - name: Type check
        run: mypy . --ignore-missing-imports || true

      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html --cov-report=term \
            --cov-fail-under=$COVERAGE_THRESHOLD

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always() && hashFiles('htmlcov/**') != ''
        with:
          name: coverage-report-python
          path: htmlcov/
          retention-days: 7

  go:
    name: Go CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.language == 'go'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Download dependencies
        run: go mod download

      - name: Run linter
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run

      - name: Run tests with coverage
        run: |
          go test ./... -v -coverprofile=coverage.out -covermode=atomic
          go tool cover -func=coverage.out | tee coverage.txt

      - name: Check coverage threshold
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Coverage $COVERAGE% is below threshold of $COVERAGE_THRESHOLD%"
            exit 1
          fi

      - name: Generate HTML coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report-go
          path: |
            coverage.out
            coverage.html
            coverage.txt
          retention-days: 7

      - name: Build
        run: go build ./...

  generic:
    name: Generic CI
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.language == 'generic'
    steps:
      - uses: actions/checkout@v4

      - name: Check for setup script
        run: |
          if [ -f "scripts/setup.js" ]; then
            echo "Run: node scripts/setup.js --help"
          fi
          echo "No language-specific CI configured yet."
          echo "Add package.json, pyproject.toml, or go.mod to enable CI."

  # Quality gate - runs after language-specific jobs
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [detect-language, node, python, go, generic]
    if: always()
    steps:
      - name: Check job results
        run: |
          # Get the result of the language-specific job
          LANG="${{ needs.detect-language.outputs.language }}"
          case $LANG in
            node) RESULT="${{ needs.node.result }}" ;;
            python) RESULT="${{ needs.python.result }}" ;;
            go) RESULT="${{ needs.go.result }}" ;;
            generic) RESULT="${{ needs.generic.result }}" ;;
            *) RESULT="skipped" ;;
          esac

          echo "Language: $LANG"
          echo "Result: $RESULT"

          if [ "$RESULT" = "failure" ]; then
            echo "::error::Quality gate failed - CI checks did not pass"
            exit 1
          elif [ "$RESULT" = "cancelled" ]; then
            echo "::warning::CI was cancelled"
            exit 1
          fi

          echo "âœ… Quality gate passed"
