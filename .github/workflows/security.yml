# Security Scanning Workflow
# Runs SAST, SCA, and container scanning on pushes and PRs

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

permissions:
  contents: read
  security-events: write
  pull-requests: read

jobs:
  # Static Application Security Testing (SAST)
  sast:
    name: SAST Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep SAST
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/cwe-top-25
          generateSarif: true

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # Software Composition Analysis (SCA) - Dependency Scanning
  sca:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'library'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # Node.js specific audit
      - name: Check for package.json
        id: check-node
        run: |
          if [ -f "package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.check-node.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run npm audit
        if: steps.check-node.outputs.exists == 'true'
        run: npm audit --audit-level=high || true

      # Python specific audit
      - name: Check for Python project
        id: check-python
        run: |
          if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        if: steps.check-python.outputs.exists == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Run pip-audit
        if: steps.check-python.outputs.exists == 'true'
        run: |
          pip install pip-audit
          pip-audit || true

  # Container Image Scanning
  container-scan:
    name: Container Scanning
    runs-on: ubuntu-latest
    # Only run if Dockerfile exists
    steps:
      - uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: check-dockerfile
        run: |
          if [ -f "Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build image for scanning
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: docker build -t scan-target:${{ github.sha }} .

      - name: Run Trivy container scan
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'scan-target:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-container.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload container scan results
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-container.sarif'

  # SBOM Generation
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Generate SBOM with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'cyclonedx'
          output: 'sbom.json'

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.json
          retention-days: 90

  # Secret scanning (backup to gitleaks pre-commit)
  secrets:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # IaC Security Scanning (Terraform, CloudFormation, K8s)
  iac-scan:
    name: IaC Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for IaC files
        id: check-iac
        run: |
          if find . -name "*.tf" -o -name "*.yaml" -o -name "*.yml" | grep -qE '\.(tf|yaml|yml)$'; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Checkov IaC scanner
        if: steps.check-iac.outputs.exists == 'true'
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          quiet: true
          soft_fail: true
          output_format: sarif
          output_file_path: checkov.sarif

      - name: Upload Checkov results
        if: steps.check-iac.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov.sarif

  # License Compliance Check
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy license scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scanners: 'license'
          severity: 'UNKNOWN,HIGH,CRITICAL'
          exit-code: '0'
